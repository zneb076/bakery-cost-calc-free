import{e as d,w as H,f as w,c as n,o,a as t,g as y,F as B,h as G,t as c,i as me,j as ve,u as be,k as ye,d as le,l as V,v as W,b as R,r as ge,m as fe,n as xe,p as we}from"./index-BAF_9aY3.js";import{d as j,S as E}from"./sweetalert2.esm.all-B80WjJMh.js";const he={class:"relative"},ke=["value"],_e={key:1,class:"absolute z-10 mt-1 max-h-60 w-full overflow-y-auto rounded-md border border-gray-300 bg-white shadow-lg"},Se={class:"bg-gray-100 px-3 py-1 text-sm font-semibold text-gray-500"},Ne=["onMousedown"],Ce={__name:"ProductRecipeAutocomplete",props:{modelValue:String,options:{type:Array,default:()=>[]}},emits:["update:modelValue","selection"],setup(Q,{emit:Y}){const _=Q,F=Y,S=d(_.modelValue||""),P=d(!1),q=d(null);H(()=>_.modelValue,p=>{S.value=p});const k=w(()=>{if(!S.value)return _.options;const p=S.value.toLowerCase(),b=[];return _.options.forEach(v=>{const h=v.options.filter(N=>N.label.toLowerCase().includes(p));h.length>0&&b.push({...v,options:h})}),b});function D(p){F("update:modelValue",p.label),F("selection",p.value),P.value=!1}function g(p){F("update:modelValue",p.target.value),P.value=!0}function f(){setTimeout(()=>{P.value=!1},200)}return(p,b)=>(o(),n("div",he,[t("input",{ref_key:"inputRef",ref:q,type:"text",value:Q.modelValue,placeholder:"-- พิมพ์เพื่อค้นหา --",onInput:g,onFocus:b[0]||(b[0]=v=>P.value=!0),onBlur:f,onKeydown:b[1]||(b[1]=(...v)=>p.handleKeydown&&p.handleKeydown(...v)),class:"w-full rounded-md border border-gray-300 px-3 py-2 pr-8"},null,40,ke),Q.modelValue?(o(),n("button",{key:0,onClick:b[2]||(b[2]=v=>D("")),type:"button",class:"absolute inset-y-0 right-0 flex items-center pr-3 text-gray-500 hover:text-gray-700"}," × ")):y("",!0),P.value&&k.value.length>0?(o(),n("ul",_e,[(o(!0),n(B,null,G(k.value,v=>(o(),n(B,{key:v.label},[t("li",Se,c(v.label),1),(o(!0),n(B,null,G(v.options,h=>(o(),n("li",{key:h.value,onMousedown:me(N=>D(h),["prevent"]),class:"cursor-pointer px-4 py-2 hover:bg-gray-100"},c(h.label),41,Ne))),128))],64))),128))])):y("",!0)]))}},Ue={class:"mx-auto max-w-4xl"},Fe={key:0,class:"py-10 text-center"},Pe={key:1},$e={class:"rounded-lg bg-white p-4 shadow-md"},Re={class:"grid grid-cols-1 items-end gap-6 md:grid-cols-4"},De={class:"md:col-span-2"},Ie=["disabled"],Le=["disabled"],Ve={key:0},We={key:1},qe={key:0,class:"mt-5 rounded-lg bg-white p-4 shadow-md"},Me={class:"mb-4 text-xl font-semibold"},Be={class:"capitalize"},Qe={class:"text-primary"},Ye={class:"mb-6 text-gray-600"},Ae={class:"overflow-x-auto"},Oe={key:0,class:"mb-2 flex items-center space-x-4 text-xs text-gray-500"},Te={key:0,class:"flex items-center space-x-1"},je={key:1,class:"flex items-center space-x-1"},Ee={class:"min-w-full"},He={class:"px-2 py-2"},Ge={class:"flex items-center"},Ke={key:0,title:"มีการคำนวณ Yield",class:"ml-2 h-2 w-2 rounded-full bg-yellow-400"},ze={key:1,title:"คิดต้นทุนเต็มหน่วย",class:"ml-2 h-2 w-2 rounded-full bg-orange-400"},Je=["onClick"],Xe={class:"px-2 py-2 text-right"},Ze={class:"px-2 py-2 text-right"},et={class:"border-t-2 border-gray-300"},tt={class:"px-2 py-3 text-right text-lg font-bold text-primary"},st={key:1,class:"mt-5 rounded-lg bg-white p-4 shadow-md"},lt={class:"mb-4 mt-4 grid grid-cols-1 gap-x-8 gap-y-6 md:grid-cols-2"},ot={class:"grid grid-cols-2 gap-4"},nt={class:"grid grid-cols-2 gap-4"},it={key:2,class:"mb-8 mt-5 rounded-lg bg-white p-4 shadow-md"},at={class:"grid grid-cols-1 gap-6 md:grid-cols-1 md:px-36 lg:grid-cols-1 lg:px-48"},rt={class:"mt-2 pl-1 text-xs"},ut={class:"pr-1 text-xs text-red-600"},dt={class:"mt-5 space-y-1"},ct={class:"flex items-center justify-between border-b pb-2 pt-2 text-base"},pt={class:"text-xs text-gray-600"},mt={class:"text-xl font-bold text-secondary"},vt={class:"flex items-center justify-between border-b py-2 text-base"},bt={class:"text-xl font-bold text-red-600"},yt={class:"flex items-center justify-between border-b py-2 text-base"},gt={class:"text-2xl font-bold text-green-600"},ft={class:"flex items-center justify-between border-b py-2 text-base"},xt={class:"text-lg font-bold text-green-600"},wt={key:2,class:"py-10 text-center text-gray-500"},ht={key:0,class:"p-6"},kt={class:"mb-4 text-2xl font-semibold"},_t={class:"list-inside list-disc space-y-2"},St={class:"font-bold"},Nt={class:"mt-6 text-right"},Ft={__name:"CostCalculatorView",setup(Q){const Y=d(null),_=be(),F=d([]),S=d([]),P=d([]),q=d([]),k=d(""),D=d(null),g=d(null),f=d(30),p=d(50),b=d(50),v=d(4),h=d(30),N=d(0),K=d(50),m=d(null),I=d(!1),A=d(!1),O=d(null),z=d(!0);async function oe(){try{z.value=!0;const[l,e,i,s]=await Promise.all([j.products.toArray(),j.recipes.toArray(),j.ingredients.toArray(),j.settings.toArray()]);F.value=l,S.value=e,q.value=e.filter(x=>x.isSubRecipe),P.value=i;const r=new Map(s.map(x=>[x.key,x.value]));b.value=r.get("laborCostPerHour")||50,v.value=r.get("workHours")||4,h.value=r.get("overheadPercent")||30,K.value=r.get("defaultProfitMargin")||50}catch(l){console.error("Fetch Data Error:",l)}finally{z.value=!1}}ve(async()=>{if(await oe(),_.query.recipeId){const l=Number(_.query.recipeId),e=S.value.find(i=>i.id===l);e&&(D.value=`recipe-${l}`,k.value=`สูตร: ${e.name}`)}if(_.query.productId){const l=Number(_.query.productId),e=F.value.find(i=>i.id===l);e&&(k.value=e.name,D.value=`product-${l}`)}});const ne=w(()=>[{label:"สินค้า",options:F.value.map(l=>({value:`product-${l.id}`,label:`${l.name} (${l.weight}g) (${l.price}บาท)`}))},{label:"สูตร",options:S.value.filter(l=>!l.isSubRecipe).map(l=>({value:`recipe-${l.id}`,label:l.name}))}]);H(D,l=>{if(m.value=null,!l){g.value=null,k.value="";return}const[e,i]=l.split("-");if(e==="product"){const s=F.value.find(r=>r.id===Number(i));s&&(g.value={type:"product",data:s},p.value=s.weight,N.value=s.price,k.value=`สินค้า: ${s.name}`)}else{const s=S.value.find(r=>r.id===Number(i));s&&(g.value={type:"recipe",data:s},N.value=0,k.value=`สูตร: ${s.name}`)}}),H([f,p],()=>{m.value=null});async function ie(){if(!g.value){E.fire({icon:"info",title:"โปรดเลือกรายการ",text:"กรุณาเลือกสินค้าหรือสูตรที่ต้องการคำนวณ"});return}I.value=!0,m.value=null;try{const l=g.value.type==="product"?g.value.data.recipeId:g.value.data.id,e=S.value.find(a=>a.id===l);if(!e||!e.ingredientsList){E.fire("เกิดข้อผิดพลาด","ไม่พบสูตรที่เชื่อมโยงกับรายการที่เลือก","error"),I.value=!1;return}const i=Number(f.value||0)*Number(p.value||0);let s=e.ingredientsList.reduce((a,C)=>a+Number(C.quantity||0),0)||1;const r=i/s,x=await J(e,r),M=x.reduce((a,C)=>a+C.totalCost,0),u=x.map(a=>({name:a.name,quantity:a.totalNetQuantity,cost:a.totalCost,appliedYield:a.appliedYield,appliedWholeUnit:a.appliedWholeUnit,isSubRecipe:a.isSubRecipe,id:a.id}));if(M<=0&&u.length>0){E.fire("คำนวณไม่ได้","ต้นทุนรวมเป็นศูนย์","warning"),I.value=!1;return}m.value={foodCost:M,costBreakdown:u,recipeName:e.name,totalWeight:i},await we(),Y.value?.scrollIntoView({behavior:"smooth"})}catch(l){console.error("Calculation Error:",l),E.fire("เกิดข้อผิดพลาด!","ไม่สามารถคำนวณต้นทุนได้","error")}finally{I.value=!1}}async function J(l,e){const i=new Map;if(!l.ingredientsList)return[];for(const s of l.ingredientsList){if(!s.quantity||typeof s.quantity!="number"||s.quantity<=0)continue;const r=Number(s.quantity)*e,x=Number(s.yield||100)/100,M=r/x;if(s.itemType==="ingredient"){const u=P.value.find(a=>a.id===s.itemId);if(u){let a=0,C=!1;if(s.costByWholeUnit&&u.purchaseUnit.toLowerCase()!=="กรัม"){C=!0;const U=Number(u.standardWeightInGrams||1),$=Math.ceil(M/U),L=Number(u.purchasePrice)/Number(u.purchaseQuantity);a=$*L}else a=M*Number(u.costPerGram||0);if(i.has(u.id)){const U=i.get(u.id);U.totalNetQuantity+=r,U.totalCost+=a,C&&(U.appliedWholeUnit=!0),x<1&&(U.appliedYield=!0)}else i.set(u.id,{id:u.id,name:u.name,totalNetQuantity:r,totalCost:a,appliedYield:x<1,appliedWholeUnit:C,isSubRecipe:!1})}}else if(s.itemType==="recipe"){const u=q.value.find(a=>a.id===s.itemId);if(u){const a=u.ingredientsList.reduce(($,L)=>$+Number(L.quantity||0),0)||1,C=r/a,U=await J(u,C);if(i.has(`sub-${u.id}`)){const $=i.get(`sub-${u.id}`);$.totalNetQuantity+=r,$.totalCost+=U.reduce((L,pe)=>L+pe.totalCost,0)}else i.set(`sub-${u.id}`,{id:u.id,name:u.name,totalNetQuantity:r,totalCost:U.reduce(($,L)=>$+L.totalCost,0),appliedYield:!1,appliedWholeUnit:!1,isSubRecipe:!0})}}}return Array.from(i.values())}async function ae(l,e){const i=q.value.find(s=>s.id===l);if(i){const s=await J(i,e/(i.ingredientsList.reduce((r,x)=>r+Number(x.quantity||0),0)||1));O.value={name:i.name,breakdown:s.map(r=>({name:r.name,quantity:r.totalNetQuantity}))},A.value=!0}}const X=w(()=>m.value?.costBreakdown.some(l=>l.appliedYield)),Z=w(()=>m.value?.costBreakdown.some(l=>l.appliedWholeUnit)),re=w(()=>Number(b.value||0)*Number(v.value||0)),ue=w(()=>m.value?m.value.foodCost*(Number(h.value||0)/100):0),T=w(()=>m.value?m.value.foodCost+re.value+ue.value:0),ee=w(()=>!f.value||!T.value?0:T.value/Number(f.value||1)),de=w(()=>ee.value*(1+Number(K.value||0)/100));H(de,l=>{g.value?.type!=="product"&&(N.value=parseFloat(l.toFixed(2)))},{immediate:!0});const te=w(()=>N.value*Number(f.value||0)),se=w(()=>m.value?te.value-T.value:0),ce=w(()=>f.value?se.value/Number(f.value||1):0);return(l,e)=>{const i=ge("font-awesome-icon");return o(),n("div",Ue,[z.value?(o(),n("div",Fe,e[10]||(e[10]=[t("p",null,"กำลังโหลดข้อมูล...",-1)]))):(o(),n("div",Pe,[t("div",$e,[e[14]||(e[14]=t("h1",{class:"mb-6 text-3xl font-bold"},"คำนวณต้นทุน Basic",-1)),t("div",Re,[t("div",De,[e[11]||(e[11]=t("label",{class:"mb-1 block text-sm font-medium text-gray-700"},"เลือกสินค้าหรือสูตร",-1)),le(Ce,{modelValue:k.value,"onUpdate:modelValue":e[0]||(e[0]=s=>k.value=s),options:ne.value,onSelection:e[1]||(e[1]=s=>D.value=s)},null,8,["modelValue","options"])]),t("div",null,[e[12]||(e[12]=t("label",{class:"mb-1 block text-sm font-medium text-gray-700"},"จำนวนที่ต้องการผลิต (ชิ้น)",-1)),V(t("input",{"onUpdate:modelValue":e[2]||(e[2]=s=>f.value=s),type:"number",class:"w-full rounded-md border border-gray-300 px-3 py-2"},null,512),[[W,f.value,void 0,{number:!0}]])]),t("div",null,[e[13]||(e[13]=t("label",{class:"mb-1 block text-sm font-medium text-gray-700"},"น้ำหนักต่อชิ้น (กรัม)",-1)),V(t("input",{"onUpdate:modelValue":e[3]||(e[3]=s=>p.value=s),disabled:g.value?.type==="product",type:"number",class:"w-full rounded-md border border-gray-300 px-3 py-2 disabled:bg-gray-200"},null,8,Ie),[[W,p.value,void 0,{number:!0}]])])]),t("div",{ref_key:"resultsSection",ref:Y,class:"mt-5 text-right"},[t("button",{onClick:ie,disabled:I.value,class:"rounded-lg bg-primary px-6 py-2 font-bold text-white transition-opacity hover:bg-opacity-90 disabled:opacity-50"},[I.value?(o(),n("span",Ve,"กำลังคำนวณ...")):(o(),n("span",We,"คำนวณต้นทุน"))],8,Le)],512)]),m.value?(o(),n("div",qe,[t("h2",Me,[e[15]||(e[15]=R(" ต้นทุนสำหรับ ")),t("span",Be,c(g.value.type==="product"?"สินค้า":"สูตร"),1),e[16]||(e[16]=R(": ")),t("span",Qe,c(g.value.data.name),1)]),t("p",Ye,[R(" สำหรับขนมจำนวน "+c(f.value)+" ชิ้น, ขนาด "+c(p.value)+" กรัม/ชิ้น ",1),e[17]||(e[17]=t("br",null,null,-1)),R(" (น้ำหนักรวม "+c(m.value.totalWeight.toLocaleString("en-US",{minimumFractionDigits:2,maximumFractionDigits:2}))+" กรัม) ",1)]),t("div",Ae,[X.value||Z.value?(o(),n("div",Oe,[e[20]||(e[20]=t("span",null,"*ต้นทุนรวมได้คำนวณตาม:",-1)),X.value?(o(),n("div",Te,e[18]||(e[18]=[t("span",{class:"h-2 w-2 rounded-full bg-yellow-400"},null,-1),t("span",null,"Yield",-1)]))):y("",!0),Z.value?(o(),n("div",je,e[19]||(e[19]=[t("span",{class:"h-2 w-2 rounded-full bg-orange-400"},null,-1),t("span",null,"หน่วยเต็ม",-1)]))):y("",!0)])):y("",!0),t("table",Ee,[e[22]||(e[22]=t("thead",null,[t("tr",{class:"border-b-2 border-gray-300"},[t("th",{class:"px-2 py-2 text-left text-sm font-semibold text-gray-700"}," วัตถุดิบ "),t("th",{class:"px-2 py-2 text-right text-sm font-semibold text-gray-700"}," ปริมาณ (กรัม) "),t("th",{class:"px-2 py-2 text-right text-sm font-semibold text-gray-700"}," ต้นทุน (บาท) ")])],-1)),t("tbody",null,[(o(!0),n(B,null,G(m.value.costBreakdown,s=>(o(),n("tr",{key:s.name,class:"border-b border-gray-200"},[t("td",He,[t("div",Ge,[t("span",null,c(s.name),1),s.appliedYield?(o(),n("span",Ke)):y("",!0),s.appliedWholeUnit?(o(),n("span",ze)):y("",!0),s.isSubRecipe?(o(),n("button",{key:2,onClick:r=>ae(s.id,s.quantity),class:"ml-2 text-blue-500 hover:text-blue-700"},[le(i,{icon:"circle-info"})],8,Je)):y("",!0)])]),t("td",Xe,c(s.quantity.toLocaleString("en-US",{minimumFractionDigits:2,maximumFractionDigits:2})),1),t("td",Ze,c(s.cost.toLocaleString("en-US",{minimumFractionDigits:2,maximumFractionDigits:2})),1)]))),128))]),t("tfoot",null,[t("tr",et,[e[21]||(e[21]=t("td",{colspan:"2",class:"px-2 py-3 text-right text-lg font-bold"}," ต้นทุนวัตถุดิบรวม ",-1)),t("td",tt,c(m.value.foodCost.toLocaleString("en-US",{minimumFractionDigits:2,maximumFractionDigits:2})),1)])])])])])):y("",!0),m.value?(o(),n("div",st,[e[27]||(e[27]=t("h3",{class:"mb-1 text-xl font-semibold text-secondary"}," ต้นทุนเพิ่มเติม ",-1)),t("div",lt,[t("div",ot,[t("div",null,[e[23]||(e[23]=t("label",{class:"block text-sm font-medium text-gray-700"},"ค่าแรง (บาท/ชม.)",-1)),V(t("input",{"onUpdate:modelValue":e[4]||(e[4]=s=>b.value=s),type:"number",class:"mt-1 w-full rounded-md border border-gray-300 px-3 py-2"},null,512),[[W,b.value,void 0,{number:!0}]])]),t("div",null,[e[24]||(e[24]=t("label",{class:"block text-sm font-medium text-gray-700"},"เวลาที่ใช้ (ชม.)",-1)),V(t("input",{"onUpdate:modelValue":e[5]||(e[5]=s=>v.value=s),type:"number",class:"mt-1 w-full rounded-md border border-gray-300 px-3 py-2"},null,512),[[W,v.value,void 0,{number:!0}]])])]),t("div",nt,[t("div",null,[e[25]||(e[25]=t("label",{class:"block text-sm font-medium text-gray-700"},"ต้นทุนแฝง (%)",-1)),V(t("input",{"onUpdate:modelValue":e[6]||(e[6]=s=>h.value=s),type:"number",class:"mt-1 w-full rounded-md border border-gray-300 px-3 py-2"},null,512),[[W,h.value,void 0,{number:!0}]])]),e[26]||(e[26]=t("div",{class:"self-end pb-2 text-gray-600"},"% ของต้นทุนวัตถุดิบ",-1))])])])):y("",!0),m.value?(o(),n("div",it,[t("div",null,[e[35]||(e[35]=t("h3",{class:"mb-4 text-xl font-semibold"},"สรุปต้นทุนและกำหนดราคาขาย",-1)),t("div",at,[t("div",null,[e[30]||(e[30]=t("span",{class:"text-xl font-bold text-primary"},"ตั้งราคาขายต่อชิ้น ",-1)),V(t("input",{type:"number",step:"0.25","onUpdate:modelValue":e[7]||(e[7]=s=>N.value=s),class:"mt-1 w-full rounded-md border border-gray-300 px-3 py-2 text-center text-3xl font-bold text-secondary"},null,512),[[W,N.value,void 0,{number:!0}]]),t("div",rt,[R(" - ราคาขายที่คำนวนมาเป็นราคา +"+c(K.value)+"% จากต้นทุน",1),e[28]||(e[28]=t("br",null,null,-1)),e[29]||(e[29]=R(" - สามารถตั้งราคาใหม่ได้เพื่อดูกำไรที่ต้องการ ")),t("div",ut," - (ราคาขายต่ำกว่า "+c(ee.value.toFixed(2))+" บาทจะขาดทุน) ",1)])])]),e[36]||(e[36]=t("div",{class:"mt-5 space-y-1"},null,-1)),t("div",dt,[t("div",ct,[t("div",null,[e[31]||(e[31]=t("span",{class:"text-lg text-gray-700"},"ยอดขายทั้งหมด:",-1)),t("div",pt," (จำนวนขนม "+c(f.value)+" ชิ้น) ",1)]),t("span",mt,c(te.value.toLocaleString("en-US",{minimumFractionDigits:2,maximumFractionDigits:2}))+" บาท",1)]),t("div",vt,[e[32]||(e[32]=t("div",null,[t("div",{class:"font-medium text-gray-600"},"ต้นทุนรวมทั้งหมด:"),t("div",{class:"text-xs text-gray-600"},"(วัตถุดิบ+น้ำไฟ+ค่าแรง)")],-1)),t("span",bt,c(T.value.toLocaleString("en-US",{minimumFractionDigits:2,maximumFractionDigits:2}))+" บาท",1)]),t("div",yt,[e[33]||(e[33]=t("span",{class:"font-medium text-gray-600"},"กำไรทั้งหมด:",-1)),t("span",gt,c(se.value.toLocaleString("en-US",{minimumFractionDigits:2,maximumFractionDigits:2}))+" บาท",1)]),t("div",ft,[e[34]||(e[34]=t("span",{class:"text-gray-600"},"กำไรต่อชิ้น:",-1)),t("span",xt,c(ce.value.toLocaleString("en-US",{minimumFractionDigits:2,maximumFractionDigits:2}))+" บาท",1)])])])])):y("",!0)])),!m.value&&!I.value?(o(),n("div",wt,e[37]||(e[37]=[t("p",null,"กรุณาเลือกสูตรและกรอกข้อมูลเพื่อคำนวณต้นทุน",-1)]))):y("",!0),A.value?(o(),ye(xe,{key:3,onClose:e[9]||(e[9]=s=>A.value=!1)},{default:fe(()=>[O.value?(o(),n("div",ht,[t("h3",kt," ส่วนประกอบของ: "+c(O.value.name),1),t("ul",_t,[(o(!0),n(B,null,G(O.value.breakdown,s=>(o(),n("li",{key:s.name},[R(c(s.name)+": ",1),t("span",St,c(s.quantity.toFixed(2)),1),e[38]||(e[38]=R(" กรัม "))]))),128))]),t("div",Nt,[t("button",{onClick:e[8]||(e[8]=s=>A.value=!1),class:"rounded-md bg-primary px-4 py-2 text-white"}," ปิด ")])])):y("",!0)]),_:1})):y("",!0)])}}};export{Ft as default};
