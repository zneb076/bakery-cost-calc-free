import{r as p,c as et,w as vt,a as d,o as a,b as t,t as r,j as M,v as J,F as P,e as I,i as C,y as E,z as yt,f as ft,g as bt,d as O,h as H,l as xt,k as D,m as K,_ as X,n as Z}from"./index-Pt9Kzntc.js";import{S as h,d as _}from"./sweetalert2.esm.all-BdfwKlh3.js";import{s as st}from"./default.css_vue_type_style_index_0_src_true_lang-OcFN8sT0.js";const ht={class:"p-2"},gt={class:"mb-4 text-2xl font-semibold"},wt={class:"space-y-4"},kt={class:"border-t pt-4"},_t={class:"space-y-3"},Ct={class:"flex items-end space-x-2"},St={class:"w-[300px] flex-grow"},Nt={class:"w-16 flex-shrink-0"},Pt=["onUpdate:modelValue"],It=["onClick"],Vt={class:"flex justify-end space-x-3 bg-gray-50 px-6 py-3"},Ut={__name:"OverheadAnalysisForm",props:{initialData:{type:Object,required:!0},availableProducts:{type:Array,required:!0}},emits:["save","cancel"],setup(W,{emit:U}){const g=W,$=U,c=p({}),R=et(()=>g.availableProducts.map(m=>({value:m.id,label:m.name})));vt(()=>g.initialData,m=>{c.value=JSON.parse(JSON.stringify(m)),(!c.value.products||c.value.products.length===0)&&(c.value.products=[{productId:null,monthlySales:null}])},{immediate:!0,deep:!0});function V(){c.value.products.push({productId:null,monthlySales:null})}function y(m){c.value.products.splice(m,1)}function F(){if(!c.value.name||!c.value.name.trim()){h.fire("ข้อมูลไม่ครบถ้วน","กรุณาใส่ชื่อกลุ่ม","error");return}const m=c.value.products.filter(i=>i.productId&&i.monthlySales>0);if(m.length===0){h.fire("ข้อมูลไม่ครบถ้วน","กรุณาเลือกสินค้าและใส่ยอดขายอย่างน้อย 1 รายการ","error");return}$("save",{...c.value,products:m})}return(m,i)=>(a(),d("form",{onSubmit:ft(F,["prevent"])},[t("div",ht,[t("h3",gt,r(c.value.id?"แก้ไขกลุ่ม":"สร้างกลุ่มสำหรับหาต้นทุนแฝง"),1),t("div",wt,[t("div",null,[i[2]||(i[2]=t("label",{class:"block text-sm font-medium"},"ชื่อกลุ่ม",-1)),M(t("input",{"onUpdate:modelValue":i[0]||(i[0]=b=>c.value.name=b),type:"text",class:"mt-1 w-full rounded-md border p-2"},null,512),[[J,c.value.name]])]),t("div",kt,[i[5]||(i[5]=t("h4",{class:"mb-2 font-semibold"},"รายการสินค้าในกลุ่ม",-1)),t("div",_t,[(a(!0),d(P,null,I(c.value.products,(b,G)=>(a(),d("div",{key:G,class:"rounded-lg bg-gray-50 p-3"},[t("div",Ct,[t("div",St,[i[3]||(i[3]=t("label",{class:"block text-xs font-medium text-gray-600"},"สินค้า",-1)),C(E(st),{modelValue:b.productId,"onUpdate:modelValue":w=>b.productId=w,options:R.value,placeholder:"เลือกสินค้า",class:"mt-1"},null,8,["modelValue","onUpdate:modelValue","options"])]),t("div",Nt,[i[4]||(i[4]=t("label",{class:"block text-xs font-medium text-gray-600"},"ยอดขาย (ชิ้น/เดือน) ",-1)),M(t("input",{"onUpdate:modelValue":w=>b.monthlySales=w,type:"number",placeholder:"ชิ้น",class:"mt-1 w-16 rounded-md border p-2"},null,8,Pt),[[J,b.monthlySales,void 0,{number:!0}]])]),t("button",{onClick:w=>y(G),type:"button",class:"flex h-5 w-5 flex-shrink-0 items-center justify-center py-5 text-red-500"},[C(E(yt),{icon:"trash"})],8,It)])]))),128))]),t("button",{onClick:V,type:"button",class:"mt-4 font-semibold text-primary"}," + เพิ่มสินค้า ")])])]),t("div",Vt,[t("button",{type:"button",onClick:i[1]||(i[1]=b=>$("cancel")),class:"rounded-md border bg-white px-4 py-2"}," ยกเลิก "),i[6]||(i[6]=t("button",{type:"submit",class:"rounded-md bg-primary px-4 py-2 text-white"}," บันทึกกลุ่ม ",-1))])],32))}},$t={key:0,class:"py-10 text-center"},Ft={key:1},Gt={class:"border-t pt-4"},Ot={class:"mb-4"},Rt={class:"space-y-3"},Bt={class:"flex items-end space-x-2"},Lt={class:"flex-grow"},Tt={class:"w-16 flex-shrink-0"},Mt=["onUpdate:modelValue"],Jt=["onClick"],jt={class:"rounded-lg bg-white p-4 shadow-md dark:bg-gray-700"},qt={class:"min-w-full"},At={key:0},Dt={class:"py-2"},Et={class:"font-semibold"},Wt={class:"text-xs text-gray-500 dark:text-slate-200"},zt={class:"space-x-2 py-2 text-right"},Qt={class:"flex flex-col items-center gap-2"},Yt=["onClick"],Ht={class:"flex gap-4"},Kt=["onClick"],Xt=["onClick"],Zt={class:"mb-4 flex items-center justify-between"},te={class:"text-2xl font-semibold"},ee={class:"dark:text-primary-dark text-primary"},se={class:"min-w-full border text-sm dark:border-gray-700"},oe={class:"px-3 py-2"},le={class:"px-3 py-2 text-right"},ne={class:"px-3 py-2 text-right text-orange-500"},ae={class:"px-3 py-2 text-right font-bold text-primary"},ie={key:0,class:"p-6"},re={class:"space-y-4 text-sm"},de={class:"mt-1 list-inside list-disc pl-4"},ue={class:"mt-1 list-inside list-disc pl-4"},ce={class:"mt-1 list-inside list-disc pl-4"},pe={class:"font-semibold"},me={class:"mt-6 text-right"},tt="overhead",be={__name:"OverheadCalculatorView",setup(W){const U=p([]),g=p([]),$=p([]),c=p([]),R=p([]),V=p(1e4),y=p(null),F=p(!0),m=p(!1),i=p(null),b=p(!1),G=p(null),w=p(null),z=p(null),S=p([{productId:null,monthlySales:null}]),ot=et(()=>g.value.map(o=>({value:o.id,label:o.name})));async function B(){try{F.value=!0;const[o,e,n,s]=await Promise.all([_.analysisGroups.where("groupType").equals(tt).toArray(),_.products.toArray(),_.recipes.toArray(),_.ingredients.toArray()]);U.value=o,g.value=e,$.value=n,R.value=n.filter(l=>l.isSubRecipe),c.value=s}catch(o){console.error("Failed to fetch data:",o)}finally{F.value=!1}}bt(B);function lt(o){i.value={...JSON.parse(JSON.stringify(o))},m.value=!0}function j(){m.value=!1,i.value=null}async function nt(o){const e={...JSON.parse(JSON.stringify(o)),groupType:tt};e.id?await _.analysisGroups.update(e.id,e):await _.analysisGroups.add(e),j(),await B(),h.fire({toast:!0,position:"top-end",icon:"success",title:"บันทึกสำเร็จ",showConfirmButton:!1,timer:3e3})}async function at(o,e){(await h.fire({title:`ลบกลุ่ม "${e}"?`,icon:"warning",showCancelButton:!0,confirmButtonColor:"#d33",confirmButtonText:"ใช่, ลบเลย",cancelButtonText:"ยกเลิก"})).isConfirmed&&(await _.analysisGroups.delete(o),await B(),h.fire({toast:!0,position:"top-end",icon:"success",title:"ลบสำเร็จ",showConfirmButton:!1,timer:3e3}))}function it(){S.value.push({productId:null,monthlySales:null})}function rt(o){S.value.splice(o,1)}function dt(o){S.value=JSON.parse(JSON.stringify(o.products)),w.value=o,h.fire({toast:!0,position:"top-end",icon:"info",title:`โหลดข้อมูลกลุ่ม "${o.name}" แล้ว`,showConfirmButton:!1,timer:2e3}),Z(()=>{z.value?.scrollIntoView({behavior:"smooth"})})}function ut(){S.value=[{productId:null,monthlySales:null}],y.value=null,w.value=null}async function ct(){if(w.value)await Q(w.value);else{const o=S.value.map(n=>{const s=g.value.find(l=>l.id===n.productId);return!s||!n.monthlySales?null:{...n,...s}}).filter(Boolean);if(o.length===0){h.fire("ข้อมูลไม่ครบถ้วน","กรุณาเลือกสินค้าและใส่ยอดขาย","warning");return}await Q({name:" (คำนวณชั่วคราว)",products:o})}}async function Q(o){if(y.value=null,!o)return;const e=[];let n=0;for(const l of o.products){const v=g.value.find(N=>N.id===l.productId),k=$.value.find(N=>N.id===v?.recipeId);if(!k||!v||!l.monthlySales)continue;const u=k.ingredientsList.reduce((N,A)=>N+Number(A.quantity||0),0)||1,x=(await Y(k)).reduce((N,A)=>N+A.totalCost,0)/u*Number(v.weight),T=x*Number(l.monthlySales);n+=T,e.push({...l,name:v.name,variableCostPerUnit:x,monthlyVariableCost:T})}if(n===0){h.fire("คำนวณไม่ได้","ต้นทุนวัตถุดิบรวมของกลุ่มเป็นศูนย์ (อาจเกิดจากสูตรไม่มีวัตถุดิบ)","warning");return}const s=e.map(l=>{const v=l.monthlyVariableCost/n,u=Number(V.value||0)*v/Number(l.monthlySales),f=l.variableCostPerUnit+u;return{name:l.name,variableCostPerUnit:l.variableCostPerUnit,overheadPerUnit:u,trueCostPerUnit:f,productId:l.productId,monthlySales:l.monthlySales,costRatio:v,monthlyVariableCost:l.monthlyVariableCost}});y.value={groupName:o.name,results:s,totalMonthlyVariableCost:n},await Z(),G.value?.scrollIntoView({behavior:"smooth"})}async function Y(o,e=1){const n=new Map;if(!o.ingredientsList)return[];for(const s of o.ingredientsList){if(!s.quantity||typeof s.quantity!="number"||s.quantity<=0)continue;const l=Number(s.quantity)*e,v=Number(s.yield||100)/100,k=l/v;if(s.itemType==="ingredient"){const u=c.value.find(f=>f.id===s.itemId);if(u){let f=0;if(s.costByWholeUnit&&u.purchaseUnit.toLowerCase()!=="กรัม"){const L=Number(u.standardWeightInGrams||1),q=Math.ceil(k/L),x=Number(u.purchasePrice)/Number(u.purchaseQuantity);f=q*x}else f=k*Number(u.costPerGram||0);n.has(u.id)?n.get(u.id).totalCost+=f:n.set(u.id,{id:u.id,name:u.name,totalCost:f})}}else if(s.itemType==="recipe"){const u=R.value.find(f=>f.id===s.itemId);if(u){const f=u.ingredientsList.reduce((x,T)=>x+Number(T.quantity||0),0)||1,L=k/f;(await Y(u,L)).forEach(x=>{n.has(x.id)?n.get(x.id).totalCost+=x.totalCost:n.set(x.id,x)})}}}return Array.from(n.values())}function pt(o){return g.value.find(e=>e.id===o)?.name||"N/A"}async function mt(){const{value:o}=await h.fire({title:"บันทึกกลุ่มวิเคราะห์",input:"text",inputLabel:"ชื่อกลุ่ม",inputPlaceholder:"ใส่ชื่อกลุ่มที่ต้องการบันทึก",showCancelButton:!0,confirmButtonText:"บันทึก",cancelButtonText:"ยกเลิก",inputValidator:e=>{if(!e)return"คุณต้องใส่ชื่อกลุ่ม!"}});if(o){const n=JSON.parse(JSON.stringify(S.value)).filter(l=>l.productId&&l.monthlySales>0);if(n.length===0){h.fire("เกิดข้อผิดพลาด","กรุณาเลือกสินค้าและใส่ยอดขายอย่างน้อย 1 รายการ","error");return}const s={name:o,products:n,groupType:"overhead"};await _.analysisGroups.add(s),await B(),h.fire({toast:!0,position:"top-end",icon:"success",title:"บันทึกกลุ่มสำเร็จ",showConfirmButton:!1,timer:3e3})}}return(o,e)=>{const n=xt("font-awesome-icon");return a(),d("div",null,[F.value?(a(),d("div",$t,e[4]||(e[4]=[t("p",null,"กำลังโหลดข้อมูล...",-1)]))):(a(),d("div",Ft,[t("div",{ref_key:"liveCalculatorSection",ref:z,class:"mb-6 rounded-lg bg-white p-4 shadow-md dark:bg-gray-700"},[e[9]||(e[9]=t("h1",{class:"mb-6 text-3xl font-bold"},"คำนวณต้นทุนแฝงต่อชิ้น",-1)),t("div",Gt,[t("div",Ot,[e[5]||(e[5]=t("label",{class:"block text-sm font-medium"},"ต้นทุนคงที่ทั้งหมด/เดือน (บาท)",-1)),M(t("input",{"onUpdate:modelValue":e[0]||(e[0]=s=>V.value=s),type:"number",class:"mt-1 w-full rounded-md border p-2 md:w-1/2 dark:bg-slate-100 dark:text-gray-600"},null,512),[[J,V.value,void 0,{number:!0}]])]),e[8]||(e[8]=t("h4",{class:"mb-2 font-semibold"},"รายการสินค้า",-1)),t("div",Rt,[(a(!0),d(P,null,I(S.value,(s,l)=>(a(),d("div",{key:l,class:"rounded-lg bg-gray-50 p-3 dark:bg-gray-400"},[t("div",Bt,[t("div",Lt,[e[6]||(e[6]=t("label",{class:"block text-xs font-medium text-gray-600"},"สินค้า",-1)),C(E(st),{modelValue:s.productId,"onUpdate:modelValue":v=>s.productId=v,options:ot.value,placeholder:"เลือกสินค้า",class:"text-gray-600"},null,8,["modelValue","onUpdate:modelValue","options"])]),t("div",Tt,[e[7]||(e[7]=t("label",{class:"block text-xs font-medium text-gray-600"},"ยอดขาย (ชิ้น/เดือน)",-1)),M(t("input",{"onUpdate:modelValue":v=>s.monthlySales=v,type:"number",placeholder:"ชิ้น",class:"mt-1 w-16 rounded-md border p-2 dark:text-gray-600"},null,8,Mt),[[J,s.monthlySales,void 0,{number:!0}]])]),t("button",{onClick:v=>rt(l),type:"button",class:"flex h-10 w-10 flex-shrink-0 items-center justify-center text-red-500"},[C(n,{icon:"trash"})],8,Jt)])]))),128))]),t("div",{class:"mt-4 flex items-center space-x-4"},[t("button",{onClick:it,type:"button",class:"dark:text-primary-dark font-semibold text-primary"}," + เพิ่มสินค้า ")]),t("div",{class:"mt-4 flex justify-end space-x-2 border-t pt-4"},[t("button",{onClick:ut,class:"rounded-lg bg-gray-300 px-4 py-2 font-bold text-gray-800"}," clear "),t("button",{onClick:mt,class:"rounded-lg border border-blue-500 px-4 py-2 text-blue-500 transition hover:bg-blue-500 hover:text-white"}," บันทึกเป็นกลุ่มใหม่ "),t("button",{onClick:ct,class:"dark:bg-primary-dark rounded-lg bg-primary px-4 py-2 font-bold text-white dark:text-gray-600"}," คำนวณ ")])])],512),t("div",jt,[e[11]||(e[11]=t("div",{class:"mb-4 flex items-center justify-between"},[t("h2",{class:"text-2xl font-semibold"},"กลุ่มที่บันทึกไว้")],-1)),t("table",qt,[t("tbody",null,[U.value.length===0?(a(),d("tr",At,e[10]||(e[10]=[t("td",{class:"py-4 text-center text-gray-500"}," ยังไม่มีกลุ่มที่บันทึกไว้... ",-1)]))):O("",!0),(a(!0),d(P,null,I(U.value,s=>(a(),d("tr",{key:s.id,class:"border-b"},[t("td",Dt,[t("p",Et,r(s.name),1),t("p",Wt," ประกอบด้วย: "+r(s.products.map(l=>pt(l.productId)).join(", ")),1)]),t("td",zt,[t("div",Qt,[t("button",{onClick:l=>dt(s),class:"rounded bg-gray-200 px-3 py-1 text-sm hover:bg-gray-300 dark:text-gray-600"}," โหลด ",8,Yt),t("div",Ht,[t("button",{onClick:l=>lt(s),class:"text-gray-500 hover:text-secondary"},[C(n,{icon:"pencil"})],8,Kt),t("button",{onClick:l=>at(s.id,s.name),class:"text-gray-500 hover:text-primary"},[C(n,{icon:"trash"})],8,Xt)])])])]))),128))])])]),y.value?(a(),d("div",{key:0,ref_key:"resultsSection",ref:G,class:"mb-8 mt-6 rounded-lg bg-white p-3 shadow-md dark:bg-gray-700"},[t("div",Zt,[t("h2",te,[e[12]||(e[12]=D(" ผลการคำนวณ:")),e[13]||(e[13]=t("br",null,null,-1)),t("span",ee,r(y.value.groupName),1)]),t("button",{onClick:e[1]||(e[1]=s=>b.value=!0),class:"text-blue-500 hover:text-blue-700"},[C(n,{icon:"circle-info"}),e[14]||(e[14]=t("span",{class:"ml-1 text-sm"},"ดูขั้นตอนการคำนวณ",-1))])]),t("table",se,[e[15]||(e[15]=t("thead",{class:"bg-gray-100 dark:bg-gray-800"},[t("tr",null,[t("th",{class:"px-3 py-2 text-left"},"ชื่อสินค้า"),t("th",{class:"w-12 px-3 py-2 text-right"},"ต้นทุนวัตถุดิบ/ชิ้น"),t("th",{class:"w-12 px-3 py-2 text-right"},"ต้นทุนแฝง/ชิ้น"),t("th",{class:"w-12 px-3 py-2 text-right"},"ต้นทุนจริง/ชิ้น")])],-1)),t("tbody",null,[(a(!0),d(P,null,I(y.value.results,s=>(a(),d("tr",{key:s.productId,class:"border-b"},[t("td",oe,r(s.name),1),t("td",le,r(s.variableCostPerUnit.toFixed(2)),1),t("td",ne,r(s.overheadPerUnit.toFixed(2)),1),t("td",ae,r(s.trueCostPerUnit.toFixed(2)),1)]))),128))])])],512)):O("",!0),m.value?(a(),H(X,{key:1,onClose:j,size:"large"},{default:K(()=>[C(Ut,{"initial-data":i.value,"available-products":g.value,onSave:nt,onCancel:j},null,8,["initial-data","available-products"])]),_:1})):O("",!0),b.value?(a(),H(X,{key:2,onClose:e[3]||(e[3]=s=>b.value=!1),size:"large"},{default:K(()=>[y.value?(a(),d("div",ie,[e[20]||(e[20]=t("h3",{class:"mb-4 text-2xl font-semibold"},"ขั้นตอนการคำนวณต้นทุนแฝง",-1)),t("div",re,[t("div",null,[e[16]||(e[16]=t("p",{class:"font-semibold"}," 1. หาต้นทุนวัตถุดิบรวมของแต่ละชนิด (ต่อเดือน) ",-1)),t("ul",de,[(a(!0),d(P,null,I(y.value.results,s=>(a(),d("li",{key:s.productId},r(s.name)+": "+r(s.variableCostPerUnit.toFixed(2))+" x "+r(s.monthlySales)+" ชิ้น = "+r(s.monthlyVariableCost.toFixed(2))+" บาท ",1))),128))])]),t("div",null,[e[17]||(e[17]=t("p",{class:"font-semibold"},'2. หา "สัดส่วนต้นทุน" ของแต่ละชนิด',-1)),t("ul",ue,[(a(!0),d(P,null,I(y.value.results,s=>(a(),d("li",{key:s.productId},r(s.name)+": "+r(s.monthlyVariableCost.toFixed(2))+" / "+r(y.value.totalMonthlyVariableCost.toFixed(2))+" = "+r((s.costRatio*100).toFixed(2))+"% ",1))),128))])]),t("div",null,[e[19]||(e[19]=t("p",{class:"font-semibold"}," 3. ปันส่วนต้นทุนคงที่ และหาต้นทุนแฝงต่อชิ้น ",-1)),t("ul",ce,[(a(!0),d(P,null,I(y.value.results,s=>(a(),d("li",{key:s.productId},[D(r(s.name)+": ("+r(Number(V.value).toLocaleString())+" x "+r((s.costRatio*100).toFixed(2))+"%) / "+r(s.monthlySales)+" ชิ้น = ",1),t("span",pe,r(s.overheadPerUnit.toFixed(2)),1),e[18]||(e[18]=D(" บาท/ชิ้น "))]))),128))])])]),t("div",me,[t("button",{onClick:e[2]||(e[2]=s=>b.value=!1),class:"rounded-md bg-primary px-4 py-2 text-white"}," ปิด ")])])):O("",!0)]),_:1})):O("",!0)]))])}}};export{be as default};
