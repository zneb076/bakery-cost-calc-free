import{r as u,w as H,c as k,a as o,o as a,b as t,d as g,F as B,e as G,t as c,f as me,g as ve,u as be,h as ge,i as le,j as V,v as W,k as R,l as ye,m as xe,_ as fe,n as ke}from"./index-CtNKjYHo.js";import{d as j,S as E}from"./sweetalert2.esm.all-BdfwKlh3.js";const we={class:"relative"},he=["value"],_e={key:1,class:"absolute z-10 mt-1 max-h-60 w-full overflow-y-auto rounded-md border border-gray-300 bg-white shadow-lg"},Se={class:"bg-gray-100 px-3 py-1 text-sm font-semibold text-gray-500"},Ne=["onMousedown"],Ce={__name:"ProductRecipeAutocomplete",props:{modelValue:String,options:{type:Array,default:()=>[]}},emits:["update:modelValue","selection"],setup(Q,{emit:Y}){const _=Q,F=Y,S=u(_.modelValue||""),P=u(!1),q=u(null);H(()=>_.modelValue,p=>{S.value=p});const h=k(()=>{if(!S.value)return _.options;const p=S.value.toLowerCase(),b=[];return _.options.forEach(v=>{const w=v.options.filter(N=>N.label.toLowerCase().includes(p));w.length>0&&b.push({...v,options:w})}),b});function D(p){F("update:modelValue",p.label),F("selection",p.value),P.value=!1}function y(p){F("update:modelValue",p.target.value),P.value=!0}function x(){setTimeout(()=>{P.value=!1},200)}return(p,b)=>(a(),o("div",we,[t("input",{ref_key:"inputRef",ref:q,type:"text",value:Q.modelValue,placeholder:"-- พิมพ์เพื่อค้นหา --",onInput:y,onFocus:b[0]||(b[0]=v=>P.value=!0),onBlur:x,onKeydown:b[1]||(b[1]=(...v)=>p.handleKeydown&&p.handleKeydown(...v)),class:"w-full rounded-md border border-gray-300 px-3 py-2 pr-8 dark:text-gray-600"},null,40,he),Q.modelValue?(a(),o("button",{key:0,onClick:b[2]||(b[2]=v=>D("")),type:"button",class:"absolute inset-y-0 right-0 flex items-center pr-3 text-gray-500 hover:text-gray-700"}," × ")):g("",!0),P.value&&h.value.length>0?(a(),o("ul",_e,[(a(!0),o(B,null,G(h.value,v=>(a(),o(B,{key:v.label},[t("li",Se,c(v.label),1),(a(!0),o(B,null,G(v.options,w=>(a(),o("li",{key:w.value,onMousedown:me(N=>D(w),["prevent"]),class:"cursor-pointer px-4 py-2 hover:bg-gray-100 dark:text-gray-500 hover:dark:bg-slate-200"},c(w.label),41,Ne))),128))],64))),128))])):g("",!0)]))}},Ue={class:"mx-auto max-w-4xl"},Fe={key:0,class:"py-10 text-center"},Pe={key:1},$e={class:"rounded-lg bg-white p-4 shadow-md dark:bg-gray-700"},Re={class:"grid grid-cols-1 items-end gap-6 md:grid-cols-4"},De={class:"md:col-span-2"},Ie=["disabled"],Le=["disabled"],Ve={key:0},We={key:1},qe={key:0,class:"mt-5 rounded-lg bg-white p-4 shadow-md dark:bg-gray-700"},Me={class:"mb-4 text-xl font-semibold"},Be={class:"capitalize"},Qe={class:"dark:text-primary-dark text-primary"},Ye={class:"mb-6 text-gray-600 dark:text-slate-200"},Ae={class:"overflow-x-auto"},Oe={key:0,class:"mb-2 flex items-center space-x-4 text-xs text-gray-500 dark:text-slate-200"},Te={key:0,class:"flex items-center space-x-1"},je={key:1,class:"flex items-center space-x-1"},Ee={class:"min-w-full"},He={class:"px-2 py-2"},Ge={class:"flex items-center"},Ke={key:0,title:"มีการคำนวณ Yield",class:"ml-2 h-2 w-2 rounded-full bg-yellow-400"},ze={key:1,title:"คิดต้นทุนเต็มหน่วย",class:"ml-2 h-2 w-2 rounded-full bg-orange-400"},Je=["onClick"],Xe={class:"px-2 py-2 text-right"},Ze={class:"px-2 py-2 text-right"},et={class:"border-t-2 border-gray-300"},tt={class:"dark:text-primary-dark px-2 py-3 text-right text-lg font-bold text-primary"},st={key:1,class:"mt-5 rounded-lg bg-white p-4 shadow-md dark:bg-gray-700"},lt={class:"mb-4 mt-4 grid grid-cols-1 gap-x-8 gap-y-6 md:grid-cols-2"},at={class:"grid grid-cols-2 gap-4"},ot={class:"grid grid-cols-2 gap-4"},it={key:2,class:"mb-8 mt-5 rounded-lg bg-white p-4 shadow-md dark:bg-gray-700"},nt={class:"grid grid-cols-1 gap-6 md:grid-cols-1 md:px-36 lg:grid-cols-1 lg:px-48"},rt={class:"mt-2 pl-1 text-xs"},dt={class:"pr-1 text-xs text-red-600 dark:text-red-400"},ut={class:"mt-5 space-y-1"},ct={class:"flex items-center justify-between border-b pb-2 pt-2 text-base"},pt={class:"text-xs text-gray-600 dark:text-slate-200"},mt={class:"text-xl font-bold text-secondary"},vt={class:"flex items-center justify-between border-b py-2 text-base"},bt={class:"text-xl font-bold text-red-600 dark:text-red-400"},gt={class:"flex items-center justify-between border-b py-2 text-base"},yt={class:"text-2xl font-bold text-green-600"},xt={class:"flex items-center justify-between border-b py-2 text-base"},ft={class:"text-lg font-bold text-green-600"},kt={key:2,class:"py-10 text-center text-gray-500"},wt={key:0,class:"p-6 dark:bg-gray-600"},ht={class:"mb-4 text-2xl font-semibold"},_t={class:"list-inside list-disc space-y-2"},St={class:"font-bold"},Nt={class:"mt-6 text-right"},Ft={__name:"CostCalculatorView",setup(Q){const Y=u(null),_=be(),F=u([]),S=u([]),P=u([]),q=u([]),h=u(""),D=u(null),y=u(null),x=u(30),p=u(50),b=u(50),v=u(4),w=u(30),N=u(0),K=u(50),m=u(null),I=u(!1),A=u(!1),O=u(null),z=u(!0);async function ae(){try{z.value=!0;const[l,e,i,s]=await Promise.all([j.products.toArray(),j.recipes.toArray(),j.ingredients.toArray(),j.settings.toArray()]);F.value=l,S.value=e,q.value=e.filter(f=>f.isSubRecipe),P.value=i;const r=new Map(s.map(f=>[f.key,f.value]));b.value=r.get("laborCostPerHour")||50,v.value=r.get("workHours")||4,w.value=r.get("overheadPercent")||30,K.value=r.get("defaultProfitMargin")||50}catch(l){console.error("Fetch Data Error:",l)}finally{z.value=!1}}ve(async()=>{if(await ae(),_.query.recipeId){const l=Number(_.query.recipeId),e=S.value.find(i=>i.id===l);e&&(D.value=`recipe-${l}`,h.value=`สูตร: ${e.name}`)}if(_.query.productId){const l=Number(_.query.productId),e=F.value.find(i=>i.id===l);e&&(h.value=e.name,D.value=`product-${l}`)}});const oe=k(()=>[{label:"สินค้า",options:F.value.map(l=>({value:`product-${l.id}`,label:`${l.name} (${l.weight}g) (${l.price}บาท)`}))},{label:"สูตร",options:S.value.filter(l=>!l.isSubRecipe).map(l=>({value:`recipe-${l.id}`,label:l.name}))}]);H(D,l=>{if(m.value=null,!l){y.value=null,h.value="";return}const[e,i]=l.split("-");if(e==="product"){const s=F.value.find(r=>r.id===Number(i));s&&(y.value={type:"product",data:s},p.value=s.weight,N.value=s.price,h.value=`สินค้า: ${s.name}`)}else{const s=S.value.find(r=>r.id===Number(i));s&&(y.value={type:"recipe",data:s},N.value=0,h.value=`สูตร: ${s.name}`)}}),H([x,p],()=>{m.value=null});async function ie(){if(!y.value){E.fire({icon:"info",title:"โปรดเลือกรายการ",text:"กรุณาเลือกสินค้าหรือสูตรที่ต้องการคำนวณ"});return}I.value=!0,m.value=null;try{const l=y.value.type==="product"?y.value.data.recipeId:y.value.data.id,e=S.value.find(n=>n.id===l);if(!e||!e.ingredientsList){E.fire("เกิดข้อผิดพลาด","ไม่พบสูตรที่เชื่อมโยงกับรายการที่เลือก","error"),I.value=!1;return}const i=Number(x.value||0)*Number(p.value||0);let s=e.ingredientsList.reduce((n,C)=>n+Number(C.quantity||0),0)||1;const r=i/s,f=await J(e,r),M=f.reduce((n,C)=>n+C.totalCost,0),d=f.map(n=>({name:n.name,quantity:n.totalNetQuantity,cost:n.totalCost,appliedYield:n.appliedYield,appliedWholeUnit:n.appliedWholeUnit,isSubRecipe:n.isSubRecipe,id:n.id}));if(M<=0&&d.length>0){E.fire("คำนวณไม่ได้","ต้นทุนรวมเป็นศูนย์","warning"),I.value=!1;return}m.value={foodCost:M,costBreakdown:d,recipeName:e.name,totalWeight:i},await ke(),Y.value?.scrollIntoView({behavior:"smooth"})}catch(l){console.error("Calculation Error:",l),E.fire("เกิดข้อผิดพลาด!","ไม่สามารถคำนวณต้นทุนได้","error")}finally{I.value=!1}}async function J(l,e){const i=new Map;if(!l.ingredientsList)return[];for(const s of l.ingredientsList){if(!s.quantity||typeof s.quantity!="number"||s.quantity<=0)continue;const r=Number(s.quantity)*e,f=Number(s.yield||100)/100,M=r/f;if(s.itemType==="ingredient"){const d=P.value.find(n=>n.id===s.itemId);if(d){let n=0,C=!1;if(s.costByWholeUnit&&d.purchaseUnit.toLowerCase()!=="กรัม"){C=!0;const U=Number(d.standardWeightInGrams||1),$=Math.ceil(M/U),L=Number(d.purchasePrice)/Number(d.purchaseQuantity);n=$*L}else n=M*Number(d.costPerGram||0);if(i.has(d.id)){const U=i.get(d.id);U.totalNetQuantity+=r,U.totalCost+=n,C&&(U.appliedWholeUnit=!0),f<1&&(U.appliedYield=!0)}else i.set(d.id,{id:d.id,name:d.name,totalNetQuantity:r,totalCost:n,appliedYield:f<1,appliedWholeUnit:C,isSubRecipe:!1})}}else if(s.itemType==="recipe"){const d=q.value.find(n=>n.id===s.itemId);if(d){const n=d.ingredientsList.reduce(($,L)=>$+Number(L.quantity||0),0)||1,C=r/n,U=await J(d,C);if(i.has(`sub-${d.id}`)){const $=i.get(`sub-${d.id}`);$.totalNetQuantity+=r,$.totalCost+=U.reduce((L,pe)=>L+pe.totalCost,0)}else i.set(`sub-${d.id}`,{id:d.id,name:d.name,totalNetQuantity:r,totalCost:U.reduce(($,L)=>$+L.totalCost,0),appliedYield:!1,appliedWholeUnit:!1,isSubRecipe:!0})}}}return Array.from(i.values())}async function ne(l,e){const i=q.value.find(s=>s.id===l);if(i){const s=await J(i,e/(i.ingredientsList.reduce((r,f)=>r+Number(f.quantity||0),0)||1));O.value={name:i.name,breakdown:s.map(r=>({name:r.name,quantity:r.totalNetQuantity}))},A.value=!0}}const X=k(()=>m.value?.costBreakdown.some(l=>l.appliedYield)),Z=k(()=>m.value?.costBreakdown.some(l=>l.appliedWholeUnit)),re=k(()=>Number(b.value||0)*Number(v.value||0)),de=k(()=>m.value?m.value.foodCost*(Number(w.value||0)/100):0),T=k(()=>m.value?m.value.foodCost+re.value+de.value:0),ee=k(()=>!x.value||!T.value?0:T.value/Number(x.value||1)),ue=k(()=>ee.value*(1+Number(K.value||0)/100));H(ue,l=>{y.value?.type!=="product"&&(N.value=parseFloat(l.toFixed(2)))},{immediate:!0});const te=k(()=>N.value*Number(x.value||0)),se=k(()=>m.value?te.value-T.value:0),ce=k(()=>x.value?se.value/Number(x.value||1):0);return(l,e)=>{const i=ye("font-awesome-icon");return a(),o("div",Ue,[z.value?(a(),o("div",Fe,e[10]||(e[10]=[t("p",null,"กำลังโหลดข้อมูล...",-1)]))):(a(),o("div",Pe,[t("div",$e,[e[14]||(e[14]=t("h1",{class:"mb-6 text-3xl font-bold"},"คำนวณต้นทุน Basic",-1)),t("div",Re,[t("div",De,[e[11]||(e[11]=t("label",{class:"mb-1 block text-sm font-medium text-gray-700 dark:text-slate-200"},"เลือกสินค้าหรือสูตร",-1)),le(Ce,{modelValue:h.value,"onUpdate:modelValue":e[0]||(e[0]=s=>h.value=s),options:oe.value,onSelection:e[1]||(e[1]=s=>D.value=s)},null,8,["modelValue","options"])]),t("div",null,[e[12]||(e[12]=t("label",{class:"mb-1 block text-sm font-medium text-gray-700 dark:text-slate-200"},"จำนวนที่ต้องการผลิต (ชิ้น)",-1)),V(t("input",{"onUpdate:modelValue":e[2]||(e[2]=s=>x.value=s),type:"number",class:"w-full rounded-md border border-gray-300 px-3 py-2 dark:text-gray-600"},null,512),[[W,x.value,void 0,{number:!0}]])]),t("div",null,[e[13]||(e[13]=t("label",{class:"mb-1 block text-sm font-medium text-gray-700 dark:text-slate-200"},"น้ำหนักต่อชิ้น (กรัม)",-1)),V(t("input",{"onUpdate:modelValue":e[3]||(e[3]=s=>p.value=s),disabled:y.value?.type==="product",type:"number",class:"w-full rounded-md border border-gray-300 px-3 py-2 disabled:bg-gray-200 dark:text-gray-600"},null,8,Ie),[[W,p.value,void 0,{number:!0}]])])]),t("div",{ref_key:"resultsSection",ref:Y,class:"mt-5 text-right"},[t("button",{onClick:ie,disabled:I.value,class:"dark:bg-primary-dark rounded-lg bg-primary px-6 py-2 font-bold text-white transition-opacity hover:bg-opacity-90 disabled:opacity-50 dark:text-gray-600"},[I.value?(a(),o("span",Ve,"กำลังคำนวณ...")):(a(),o("span",We,"คำนวณต้นทุน"))],8,Le)],512)]),m.value?(a(),o("div",qe,[t("h2",Me,[e[15]||(e[15]=R(" ต้นทุนสำหรับ ")),t("span",Be,c(y.value.type==="product"?"สินค้า":"สูตร"),1),e[16]||(e[16]=R(": ")),t("span",Qe,c(y.value.data.name),1)]),t("p",Ye,[R(" สำหรับขนมจำนวน "+c(x.value)+" ชิ้น, ขนาด "+c(p.value)+" กรัม/ชิ้น ",1),e[17]||(e[17]=t("br",null,null,-1)),R(" (น้ำหนักรวม "+c(m.value.totalWeight.toLocaleString("en-US",{minimumFractionDigits:2,maximumFractionDigits:2}))+" กรัม) ",1)]),t("div",Ae,[X.value||Z.value?(a(),o("div",Oe,[e[20]||(e[20]=t("span",null,"*ต้นทุนรวมได้คำนวณตาม:",-1)),X.value?(a(),o("div",Te,e[18]||(e[18]=[t("span",{class:"h-2 w-2 rounded-full bg-yellow-400"},null,-1),t("span",null,"Yield",-1)]))):g("",!0),Z.value?(a(),o("div",je,e[19]||(e[19]=[t("span",{class:"h-2 w-2 rounded-full bg-orange-400"},null,-1),t("span",null,"หน่วยเต็ม",-1)]))):g("",!0)])):g("",!0),t("table",Ee,[e[22]||(e[22]=t("thead",null,[t("tr",{class:"border-b-2 border-gray-300 dark:bg-gray-700"},[t("th",{class:"px-2 py-2 text-left text-sm font-semibold text-gray-700 dark:text-slate-200"}," วัตถุดิบ "),t("th",{class:"px-2 py-2 text-right text-sm font-semibold text-gray-700 dark:text-slate-200"}," ปริมาณ (กรัม) "),t("th",{class:"px-2 py-2 text-right text-sm font-semibold text-gray-700 dark:text-slate-200"}," ต้นทุน (บาท) ")])],-1)),t("tbody",null,[(a(!0),o(B,null,G(m.value.costBreakdown,s=>(a(),o("tr",{key:s.name,class:"border-b border-gray-200"},[t("td",He,[t("div",Ge,[t("span",null,c(s.name),1),s.appliedYield?(a(),o("span",Ke)):g("",!0),s.appliedWholeUnit?(a(),o("span",ze)):g("",!0),s.isSubRecipe?(a(),o("button",{key:2,onClick:r=>ne(s.id,s.quantity),class:"ml-2 text-blue-500 hover:text-blue-700"},[le(i,{icon:"circle-info"})],8,Je)):g("",!0)])]),t("td",Xe,c(s.quantity.toLocaleString("en-US",{minimumFractionDigits:2,maximumFractionDigits:2})),1),t("td",Ze,c(s.cost.toLocaleString("en-US",{minimumFractionDigits:2,maximumFractionDigits:2})),1)]))),128))]),t("tfoot",null,[t("tr",et,[e[21]||(e[21]=t("td",{colspan:"2",class:"px-2 py-3 text-right text-lg font-bold"}," ต้นทุนวัตถุดิบรวม ",-1)),t("td",tt,c(m.value.foodCost.toLocaleString("en-US",{minimumFractionDigits:2,maximumFractionDigits:2})),1)])])])])])):g("",!0),m.value?(a(),o("div",st,[e[27]||(e[27]=t("h3",{class:"mb-1 text-xl font-semibold text-secondary"}," ต้นทุนเพิ่มเติม ",-1)),t("div",lt,[t("div",at,[t("div",null,[e[23]||(e[23]=t("label",{class:"block text-sm font-medium text-gray-700 dark:text-slate-200"},"ค่าแรง (บาท/ชม.)",-1)),V(t("input",{"onUpdate:modelValue":e[4]||(e[4]=s=>b.value=s),type:"number",class:"mt-1 w-full rounded-md border border-gray-300 px-3 py-2 dark:bg-slate-100 dark:text-gray-600"},null,512),[[W,b.value,void 0,{number:!0}]])]),t("div",null,[e[24]||(e[24]=t("label",{class:"block text-sm font-medium text-gray-700 dark:text-slate-200"},"เวลาที่ใช้ (ชม.)",-1)),V(t("input",{"onUpdate:modelValue":e[5]||(e[5]=s=>v.value=s),type:"number",class:"mt-1 w-full rounded-md border border-gray-300 px-3 py-2 dark:bg-slate-100 dark:text-gray-600"},null,512),[[W,v.value,void 0,{number:!0}]])])]),t("div",ot,[t("div",null,[e[25]||(e[25]=t("label",{class:"block text-sm font-medium text-gray-700 dark:text-slate-200"},"ต้นทุนแฝง (%)",-1)),V(t("input",{"onUpdate:modelValue":e[6]||(e[6]=s=>w.value=s),type:"number",class:"mt-1 w-full rounded-md border border-gray-300 px-3 py-2 dark:bg-slate-100 dark:text-gray-600"},null,512),[[W,w.value,void 0,{number:!0}]])]),e[26]||(e[26]=t("div",{class:"self-end pb-2 text-gray-600 dark:text-slate-200"}," % ของต้นทุนวัตถุดิบ ",-1))])])])):g("",!0),m.value?(a(),o("div",it,[t("div",null,[e[35]||(e[35]=t("h3",{class:"mb-4 text-xl font-semibold"},"สรุปต้นทุนและกำหนดราคาขาย",-1)),t("div",nt,[t("div",null,[e[30]||(e[30]=t("span",{class:"dark:text-primary-dark text-xl font-bold text-primary"},"ตั้งราคาขายต่อชิ้น ",-1)),V(t("input",{type:"number",step:"0.25","onUpdate:modelValue":e[7]||(e[7]=s=>N.value=s),class:"mt-1 w-full rounded-md border border-gray-300 px-3 py-2 text-center text-3xl font-bold text-secondary dark:bg-slate-100"},null,512),[[W,N.value,void 0,{number:!0}]]),t("div",rt,[R(" - ราคาขายที่คำนวนมาเป็นราคา +"+c(K.value)+"% จากต้นทุน",1),e[28]||(e[28]=t("br",null,null,-1)),e[29]||(e[29]=R(" - สามารถตั้งราคาใหม่ได้เพื่อดูกำไรที่ต้องการ ")),t("div",dt," - (ราคาขายต่ำกว่า "+c(ee.value.toFixed(2))+" บาทจะขาดทุน) ",1)])])]),e[36]||(e[36]=t("div",{class:"mt-5 space-y-1"},null,-1)),t("div",ut,[t("div",ct,[t("div",null,[e[31]||(e[31]=t("span",{class:"text-lg text-gray-700 dark:text-slate-200"},"ยอดขายทั้งหมด:",-1)),t("div",pt," (จำนวนขนม "+c(x.value)+" ชิ้น) ",1)]),t("span",mt,c(te.value.toLocaleString("en-US",{minimumFractionDigits:2,maximumFractionDigits:2}))+" บาท",1)]),t("div",vt,[e[32]||(e[32]=t("div",null,[t("div",{class:"font-medium text-gray-600 dark:text-slate-200"}," ต้นทุนรวมทั้งหมด: "),t("div",{class:"text-xs text-gray-600 dark:text-slate-200"}," (วัตถุดิบ+น้ำไฟ+ค่าแรง) ")],-1)),t("span",bt,c(T.value.toLocaleString("en-US",{minimumFractionDigits:2,maximumFractionDigits:2}))+" บาท",1)]),t("div",gt,[e[33]||(e[33]=t("span",{class:"font-medium text-gray-600 dark:text-slate-200"},"กำไรทั้งหมด:",-1)),t("span",yt,c(se.value.toLocaleString("en-US",{minimumFractionDigits:2,maximumFractionDigits:2}))+" บาท",1)]),t("div",xt,[e[34]||(e[34]=t("span",{class:"text-gray-600 dark:text-slate-200"},"กำไรต่อชิ้น:",-1)),t("span",ft,c(ce.value.toLocaleString("en-US",{minimumFractionDigits:2,maximumFractionDigits:2}))+" บาท",1)])])])])):g("",!0)])),!m.value&&!I.value?(a(),o("div",kt,e[37]||(e[37]=[t("p",null,"กรุณาเลือกสูตรและกรอกข้อมูลเพื่อคำนวณต้นทุน",-1)]))):g("",!0),A.value?(a(),ge(fe,{key:3,onClose:e[9]||(e[9]=s=>A.value=!1)},{default:xe(()=>[O.value?(a(),o("div",wt,[t("h3",ht," ส่วนประกอบของ: "+c(O.value.name),1),t("ul",_t,[(a(!0),o(B,null,G(O.value.breakdown,s=>(a(),o("li",{key:s.name},[R(c(s.name)+": ",1),t("span",St,c(s.quantity.toFixed(2)),1),e[38]||(e[38]=R(" กรัม "))]))),128))]),t("div",Nt,[t("button",{onClick:e[8]||(e[8]=s=>A.value=!1),class:"dark:bg-primary-dark rounded-md bg-primary px-4 py-2 text-white dark:text-gray-600"}," ปิด ")])])):g("",!0)]),_:1})):g("",!0)])}}};export{Ft as default};
